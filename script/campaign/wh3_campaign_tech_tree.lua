scripted_technology_tree = {
	region_mapping = {
		wh3_main_combi_region_naggarond = {
			wh_dlc08_tech_nor_nw_02 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_lothern = {
			wh_dlc08_tech_nor_nw_04 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_hexoatl = {
			wh_dlc08_tech_nor_nw_06 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_skavenblight = {
			wh_dlc08_tech_nor_nw_08 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_khemri = {
			wh_dlc08_tech_nor_nw_10 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_the_awakening = {
			wh_dlc08_tech_nor_nw_20 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_couronne = {
			wh_dlc08_tech_nor_other_07 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_karaz_a_karak = {
			wh_dlc08_tech_nor_other_11 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_altdorf = {
			wh_dlc08_tech_nor_other_14 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_castle_drakenhof = {
			wh_dlc08_tech_nor_other_16 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_black_crag = {
			wh_dlc08_tech_nor_other_18 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_great_hall_of_greasus = {
			wh3_main_ie_tech_nor_darklands_hate_ogre_kingdoms = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_the_oak_of_ages = {
			wh_dlc08_tech_nor_other_20 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_zharr_naggrund = {
			wh3_main_ie_tech_nor_darklands_hate_chaos_dwarfs = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_chaos_region_kislev = {
			wh3_main_ie_tech_nor_oldworld_hate_kislev = {culture = "wh_dlc08_nor_norsca", allow_allies = false},
		},
		wh3_main_combi_region_wei_jin = {
			wh3_main_ie_tech_nor_darklands_hate_cathay = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_tor_achare = {
			wh3_dlc27_tech_nor_cul_slaanesh = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_dragon_fang_mount = {
			wh3_dlc27_tech_nor_cul_nurgle = {culture = "wh_dlc08_nor_norsca", allow_allies = false},
		},
		wh3_main_combi_region_fateweavers_crevasse = {
			wh3_dlc27_tech_nor_cul_tzeentch = {culture = "wh_dlc08_nor_norsca", allow_allies = false},
		},
		wh3_main_combi_region_deff_gorge = {
			wh3_dlc27_tech_nor_cul_khorne = {culture = "wh_dlc08_nor_norsca", allow_allies = false},
		},
		wh3_main_combi_region_the_writhing_fortress = {
			wh3_dlc27_tech_nor_cul_chaos = {culture = "wh_dlc08_nor_norsca", allow_allies = false},
		}

	},
	ancillary_mapping = {
		wh2_dlc11_tech_cst_firearms_07 =	{ancillary = "wh2_dlc11_anc_follower_cst_powder_monkey", count = 1},
		wh2_dlc11_tech_cst_firearms_08 =	{ancillary = "wh2_dlc11_anc_follower_cst_master_gunner", count = 1},
		wh2_dlc11_tech_cst_firearms_09 =	{ancillary = "wh2_dlc11_anc_magic_standard_throwing_bombs", count = 1},
		wh2_dlc11_tech_cst_vampiric_10 =	{ancillary = "wh2_dlc11_anc_magic_standard_spell_of_the_necromancers_apprentice", count = 1},
		wh2_dlc11_tech_cst_vampiric_11 =	{ancillary = "wh2_dlc11_anc_magic_standard_skull_and_crossbones", count = 1},
		wh2_dlc11_tech_cst_vampiric_12 =	{ancillary = "wh2_dlc11_anc_follower_cst_carpenter", count = 1},
		wh2_dlc11_tech_cst_command_10 =		{ancillary = "wh2_dlc11_anc_follower_cst_quartermaster", count = 1},
		wh2_dlc11_tech_cst_command_11 =		{ancillary = "wh2_dlc11_anc_follower_cst_first_mate", count = 1},
		wh2_dlc11_tech_cst_command_12 =		{ancillary = "wh2_dlc11_anc_follower_cst_sea_artist", count = 1},
		wh3_main_tech_cth_2 =				{ancillary = "wh3_main_anc_magic_standard_banner_of_feng_shi", count = 1},
		wh3_main_tech_cth_22 =				{ancillary = "wh3_main_anc_magic_standard_banner_of_the_moon_empress", count = 1},
		wh3_main_tech_cth_50 =				{ancillary = "wh3_main_anc_magic_standard_the_great_celestial_banner", count = 1},
		wh3_main_tech_cth_65 =				{ancillary = "wh3_main_anc_magic_standard_banner_of_the_empress_eye", count = 1},
		wh3_main_tech_kho_1_5 =				{ancillary = "wh3_main_anc_magic_standard_blood_feasters_banner", count = 1},
		wh3_main_tech_kho_3_5 =				{ancillary = "wh3_main_anc_magic_standard_trophy_of_killers", count = 1},
		wh3_main_tech_kho_4_3 =				{ancillary = "wh3_main_anc_magic_standard_khornes_gift", count = 1},
		wh3_main_tech_kho_6_2 =				{ancillary = "wh3_main_anc_magic_standard_lifetaker_banner", count = 1},
		wh3_main_tech_ksl_4_14 =			{ancillary = "wh3_main_anc_magic_standard_banner_of_the_orthodoxy", count = 3}
	},
	khorne_techs_battle_wins = {
		wh3_main_tech_kho_1_4 = {culture = "wh3_main_kho_khorne", value = 5},
		wh3_main_tech_kho_3_3 = {culture = "wh3_main_kho_khorne", value = 5},
		wh3_main_tech_kho_2_3 = {culture = "wh3_main_kho_khorne", value = 5},
		wh3_main_tech_kho_1_8 = {culture = "wh3_main_kho_khorne", value = 5},
		wh3_main_tech_kho_3_4 = {culture = "wh3_main_kho_khorne", value = 5},
		wh3_main_tech_kho_2_8 = {culture = "wh3_main_kho_khorne", value = 5},
		wh3_main_tech_kho_2_4 = {culture = "wh3_main_kho_khorne", value = 10},
		wh3_main_tech_kho_4_8 = {culture = "wh3_main_kho_khorne", value = 10},
		wh3_main_tech_kho_8_4 = {culture = "wh3_main_kho_khorne", value = 10},
		wh3_dlc26_tech_kho_campaign_4_3 = {culture = "wh3_main_kho_khorne", value = 10},
		wh3_main_tech_kho_3_7 = {culture = "wh3_main_kho_khorne", value = 10},
		wh3_main_tech_kho_3_2 = {culture = "wh3_main_kho_khorne", value = 10},
		wh3_main_tech_kho_2_2 = {culture = "wh3_main_kho_khorne", value = 15},
		wh3_main_tech_kho_1_2 = {culture = "wh3_main_kho_khorne", value = 15},
		wh3_main_tech_kho_8_8 = {culture = "wh3_main_kho_khorne", value = 15},
		wh3_main_tech_kho_8_3 = {culture = "wh3_main_kho_khorne", value = 15},
		wh3_dlc26_tech_kho_blood_hosts_1 = {culture = "wh3_main_kho_khorne", value = 15},
		wh3_main_tech_kho_1_6 = {culture = "wh3_main_kho_khorne", value = 15},
		wh3_main_tech_kho_8_5 = {culture = "wh3_main_kho_khorne", value = 20},
		wh3_main_tech_kho_3_8 = {culture = "wh3_main_kho_khorne", value = 20},
		wh3_main_tech_kho_6_3 = {culture = "wh3_main_kho_khorne", value = 20},
		wh3_main_tech_kho_6_6 = {culture = "wh3_main_kho_khorne", value = 20},
		wh3_main_tech_kho_8_6 = {culture = "wh3_main_kho_khorne", value = 20},
		wh3_main_tech_kho_5_7 = {culture = "wh3_main_kho_khorne", value = 20},
		wh3_main_tech_kho_6_7 = {culture = "wh3_main_kho_khorne", value = 25},
		wh3_main_tech_kho_5_8 = {culture = "wh3_main_kho_khorne", value = 25},
		wh3_main_tech_kho_4_4 = {culture = "wh3_main_kho_khorne", value = 25},
		wh3_main_tech_kho_5_2 = {culture = "wh3_main_kho_khorne", value = 25},
		wh3_main_tech_kho_6_5 = {culture = "wh3_main_kho_khorne", value = 25},
		wh3_main_tech_kho_5_5 = {culture = "wh3_main_kho_khorne", value = 25}
	},
	norsca_techs_battle_wins = {
		wh_dlc08_tech_nor_nw_08 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh2_main_skv_skaven", value = 10},
		wh_dlc08_tech_nor_nw_20 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh2_dlc11_cst_vampire_coast", value = 10},
		wh_dlc08_tech_nor_other_20 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh_dlc05_wef_wood_elves", value = 10},
		wh_dlc08_tech_nor_nw_04 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh2_main_hef_high_elves", value = 10},
		wh3_main_ie_tech_nor_darklands_hate_cathay = {culture = "wh_dlc08_nor_norsca", target_culture = "wh3_main_cth_cathay", value = 10},
		wh3_dlc27_tech_nor_cul_slaanesh = {culture = "wh_dlc08_nor_norsca", target_culture = "wh3_main_sla_slaanesh", value = 10},
		wh3_main_ie_tech_nor_darklands_hate_chaos_dwarfs = {culture = "wh_dlc08_nor_norsca", target_culture = "wh3_dlc23_chd_chaos_dwarfs", value = 10},
		wh3_main_ie_tech_nor_oldworld_hate_kislev = {culture = "wh_dlc08_nor_norsca", target_culture = "wh3_main_ksl_kislev", value = 10},
		wh_dlc08_tech_nor_other_07 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh_main_brt_bretonnia", value = 10},
		wh_dlc08_tech_nor_nw_02 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh2_main_def_dark_elves", value = 10},
		wh3_dlc27_tech_nor_cul_beastmen = {culture = "wh_dlc08_nor_norsca", target_culture = "wh_dlc03_bst_beastmen", value = 10},
		wh_dlc08_tech_nor_nw_06 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh2_main_lzd_lizardmen", value = 10},
		wh_dlc08_tech_nor_nw_10 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh2_dlc09_tmb_tomb_kings", value = 10},
		wh_dlc08_tech_nor_other_11 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh_main_dwf_dwarfs", value = 10},
		wh_dlc08_tech_nor_other_14 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh_main_emp_empire", value = 10},
		wh3_dlc27_tech_nor_cul_nurgle = {culture = "wh_dlc08_nor_norsca", target_culture = "wh3_main_nur_nurgle", value = 10},
		wh_dlc08_tech_nor_other_16 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh_main_vmp_vampire_counts", value = 10},
		wh_dlc08_tech_nor_other_18 = {culture = "wh_dlc08_nor_norsca", target_culture = "wh_main_grn_greenskins", value = 10},
		wh3_main_ie_tech_nor_darklands_hate_ogre_kingdoms = {culture = "wh_dlc08_nor_norsca", target_culture = "wh3_main_ogr_ogre_kingdoms", value = 10},
		wh3_dlc27_tech_nor_cul_norsca = {culture = "wh_dlc08_nor_norsca", target_culture = "wh_dlc08_nor_norsca", value = 10},
		wh3_dlc27_tech_nor_cul_tzeentch = {culture = "wh_dlc08_nor_norsca", target_culture = "wh3_main_tze_tzeentch", value = 10},
		wh3_dlc27_tech_nor_cul_khorne = {culture = "wh_dlc08_nor_norsca", target_culture = "wh3_main_kho_khorne", value = 10},
		wh3_dlc27_tech_nor_cul_chaos = {culture = "wh_dlc08_nor_norsca", target_culture = "wh_main_chs_chaos", value = 10},
	}
}

scripted_technology_tree.target_culture_any = "any"
scripted_technology_tree.persistent_key = "scripted_technology_tree"
scripted_technology_tree.persistent = {
	version = 0,
	battle_wins = {
		-- example of what this might look like when saved
		-- at version 0:
		-- ["wh_dlc08_nor_norsca"] = {
		-- 	["wh3_main_nur_nurgle"] = 1,
		-- 	["wh3_main_sla_slaanesh"] = 3,
		-- 	...
		-- },
		-- ...
	},
}

function scripted_technology_tree:get_battle_wins_count(faction_key, target_culture_key)
	local faction_table = scripted_technology_tree.persistent.battle_wins[faction_key]
	if faction_table == nil then
		return 0
	end

	local saved_target_culture_key = self:get_battle_wins_target_culture_key(target_culture_key)
	return faction_table[saved_target_culture_key] or 0
end

function scripted_technology_tree:set_battle_wins_count(faction_key, target_culture_key, wins_count)
	local saved_target_culture_key = self:get_battle_wins_target_culture_key(target_culture_key)

	local faction_table = scripted_technology_tree.persistent.battle_wins[faction_key]
	if faction_table then
		faction_table[saved_target_culture_key] = wins_count
		return
	end

	scripted_technology_tree.persistent.battle_wins[faction_key] = {
		[saved_target_culture_key] = wins_count
	}
end

function scripted_technology_tree:get_battle_wins_target_culture_key(target_culture_key)
	return target_culture_key or scripted_technology_tree.target_culture_any
end

function scripted_technology_tree:start_technology_listeners()
	if cm:is_new_game() then
		for region_key, technologies in pairs(self.region_mapping) do
			local region = cm:get_region(region_key)
			
			if region then
				-- lock the technology for all factions
				self:toggle_technology(technologies)
				
				-- unlock it for the owner in the start pos
				
				if not region:is_abandoned() then
					self:toggle_technology(technologies, region:owning_faction())
				end
			end
		end

		self:toggle_technology(self.khorne_techs_battle_wins)
		self:toggle_technology(self.norsca_techs_battle_wins)
	end
	
	core:add_listener(
		"tech_researched_ancillary_provided",
		"ResearchCompleted",
		true,
		function(context)
			local ancillary_map = self.ancillary_mapping[context:technology()]
				
			if ancillary_map then
				local ancillary = ancillary_map.ancillary
				local count = ancillary_map.count
				
				for i = 1, count do
				cm:add_ancillary_to_faction(context:faction(), ancillary, false)
				end
			end
		end,
		true
	)
	
	core:add_listener(
		"region_changed_technology_unlock",
		"RegionFactionChangeEvent",
		function(context)
			return self.region_mapping[context:region():name()]
		end,
		function(context)
			local region = context:region()
			local owning_faction = false
			
			if not region:is_abandoned() then
				owning_faction = region:owning_faction()
			end
			
			self:toggle_technology(self.region_mapping[region:name()], owning_faction)
		end,
		true
	)
	
	core:add_listener(
		"diplomatic_treaty_technology_unlock",
		"PositiveDiplomaticEvent",
		function(context)
			return context:is_military_alliance() or context:is_defensive_alliance() or context:is_vassalage()
		end,
		function(context)
			self:resolve_diplomatic_event(context:proposer(), context:recipient())
		end,
		true
	)
	
	core:add_listener(
		"diplomatic_treaty_technology_unlock",
		"NegativeDiplomaticEvent",
		function(context)
			return context:was_military_alliance() or context:was_defensive_alliance() or context:was_vassalage()
		end,
		function(context)
			self:resolve_diplomatic_event(context:proposer(), context:recipient())
		end,
		true
	)

	core:add_listener(
		"khorne_battle_victory_technology_unlock",
		"BattleCompleted",
		function()
			return cm:pending_battle_cache_culture_is_involved("wh3_main_kho_khorne")
		end,
		function()
			local winning_factions = {}
			if cm:pending_battle_cache_attacker_victory() then
				for i = 1, cm:pending_battle_cache_num_attackers() do
					local char_cqi, mf_cqi, faction_key = cm:pending_battle_cache_get_attacker(i)
					winning_factions[faction_key] = true
				end
			elseif cm:pending_battle_cache_defender_victory() then
				for i = 1, cm:pending_battle_cache_num_defenders() do
					local char_cqi, mf_cqi, faction_key = cm:pending_battle_cache_get_defender(i)
					winning_factions[faction_key] = true
				end
			end

			for faction_key, _ in pairs(winning_factions) do
				self:check_conditions_tech_battle_victories(faction_key, "wh3_main_kho_khorne", self.khorne_techs_battle_wins)
			end
		end,
		true
	)

	-- added dlc27 
	core:add_listener(
		"norsca_battle_victory_technology_unlock",
		"BattleCompleted",
		function()
			for key, data in dpairs(self.norsca_techs_battle_wins) do 
				if cm:pending_battle_cache_culture_is_involved(data.target_culture) and cm:pending_battle_cache_culture_is_involved("wh_dlc08_nor_norsca") then
					return true
				end
			end
		end,
		function()
			local all_winner_faction_to_loser_culture_pairs = {}
			if cm:pending_battle_cache_attacker_victory() then
				for i = 1, cm:pending_battle_cache_num_attackers() do
					local _, _, faction_key = cm:pending_battle_cache_get_attacker(i)
					for j = 1, cm:pending_battle_cache_num_defenders() do
						local _, _, target_faction = cm:pending_battle_cache_get_defender(j)
						if target_faction ~= "rebels" then 
						local faction = cm:get_faction(target_faction)						
							if not faction:is_null_interface() then 
								all_winner_faction_to_loser_culture_pairs[faction_key] = faction:culture()
							end
						end 	
					end
				end
			elseif cm:pending_battle_cache_defender_victory() then
				for i = 1, cm:pending_battle_cache_num_defenders() do
					local _, _, faction_key = cm:pending_battle_cache_get_defender(i)
					for j = 1, cm:pending_battle_cache_num_attackers() do
						local _, _, target_faction = cm:pending_battle_cache_get_attacker(j)
						if target_faction ~= "rebels" then 
							local faction = cm:get_faction(target_faction)
							if not faction:is_null_interface() then 
								all_winner_faction_to_loser_culture_pairs[faction_key] = faction:culture()
							end
						end
					end
				end
			end

			for faction_key, target_culture in pairs(all_winner_faction_to_loser_culture_pairs) do
				self:check_conditions_tech_battle_victories(faction_key, "wh_dlc08_nor_norsca", self.norsca_techs_battle_wins, target_culture)
			end
		end,
		true
	)
end

-- added dlc27 
function scripted_technology_tree:check_conditions_tech_battle_victories(faction_key, faction_culture, faction_tech_battles_unlock_table, target_culture)
	local faction = cm:get_faction(faction_key)

	if not faction or faction:is_rebel() then
		return
	end

	if faction:culture() ~= faction_culture then
		return
	end

	-- get and update the wins count
	local wins_count = self:get_battle_wins_count(faction_key, target_culture)
	wins_count = wins_count + 1
	self:set_battle_wins_count(faction_key, target_culture, wins_count)

	for technology_key, details in pairs(faction_tech_battles_unlock_table) do
		--if there is a target culture we only increment those
		if target_culture then
			if details.value and details.target_culture == target_culture then
				self:count_tech_battle_victories(wins_count, details.value, faction_key, technology_key)
			end
		else
			if details.value then
				self:count_tech_battle_victories(wins_count, details.value, faction_key, technology_key)
			end
		end
	end
end

-- modified dlc27 
function scripted_technology_tree:count_tech_battle_victories(wins, value, faction_key, technology_key)
	if wins >= value then
		cm:unlock_technology(faction_key, technology_key)
	else
		cm:update_technology_unlock_progress_values(faction_key, technology_key, {value, wins})
	end
end

function scripted_technology_tree:resolve_diplomatic_event(proposer, recipient)
	-- delay this by a tick as the treaty isn't created until just after this event
	cm:callback(
		function()
			for region_key, technologies in pairs(self.region_mapping) do
				local region = cm:get_region(region_key)
				
				if region and not region:is_abandoned() then
					local owning_faction = region:owning_faction()
					
					if owning_faction == proposer then
						self:toggle_technology(technologies, proposer)
					elseif owning_faction == recipient then
						self:toggle_technology(technologies, recipient)
					end
				end
			end
		end,
		0.2
	)
end

function scripted_technology_tree:toggle_technology(technologies, region_owner)
	-- unlock each technology tied to the region for the new owner and allies if needed
	if region_owner and not region_owner:is_rebel() then
		local faction_culture = region_owner:culture()
		-- build a list of allies and vassals
		local ally_list = {}
		for _, current_faction in model_pairs(region_owner:factions_allied_with()) do
			table.insert(ally_list, current_faction)
		end
		for _, current_faction in model_pairs(region_owner:vassals()) do
			table.insert(ally_list, current_faction)
		end
		
		for technology_key, details in pairs(technologies) do
			if faction_culture == details.culture then
				cm:unlock_technology(region_owner:name(), technology_key)
			end
			
			if details.allow_allies then
				for i = 1, #ally_list do
					local current_ally = ally_list[i]
					
					if current_ally:culture() == details.culture then
						cm:unlock_technology(current_ally:name(), technology_key)
					end
				end
			end
		end
	end
	
	-- lock the technology for every other faction, excluding allies if needed, of that culture
	local faction_list = cm:model():world():faction_list()
	
	for _, current_faction in model_pairs(faction_list) do
		local current_faction_culture = current_faction:culture()
		
		for technology_key, details in pairs(technologies) do
			if current_faction_culture == details.culture and region_owner ~= current_faction and (not region_owner or (details.allow_allies and region_owner and not region_owner:is_ally_vassal_or_client_state_of(current_faction))) then
				cm:lock_technology(current_faction:name(), technology_key)

				if details.value then
					cm:update_technology_unlock_progress_values(current_faction:name(), technology_key, {details.value, 0})
				end
			end
		end
	end
end

--------------------------------------------------------------
----------------------- SAVING / LOADING ---------------------
--------------------------------------------------------------

cm:add_saving_game_callback(
	function(context)
		cm:save_named_value(scripted_technology_tree.persistent_key, scripted_technology_tree.persistent, context)
	end
)
cm:add_loading_game_callback(
	function(context)
		if cm:is_new_game() then
			return
		end

		local current_version = 0
		
		-- set -1 for the version here to detect whether this even
		-- existed in the save file - if it's still -1 after loading
		-- then we know it didn't
		scripted_technology_tree.persistent.version = -1
		scripted_technology_tree.persistent = cm:load_named_value(
			scripted_technology_tree.persistent_key,
			scripted_technology_tree.persistent,
			context)

		if scripted_technology_tree.persistent.version ~= current_version then
			if scripted_technology_tree.persistent.version == -1 then
				-- the structure is not present in the save file
				-- load the data from the initial format and convert it

				-- note: in the initial format, only data for knorne factions was
				-- saved and there was no separation per target culture
				-- the target culture still doesn't matter in version 0, so using 'any'

				-- note: needs to happen after the world has been created
				core:add_listener(
					"scripted_technology_tree_world_created",
					"WorldCreated",
					true,
					function(context)
						-- check whether there is a saved wins count for each faction and
						-- if so, set the count in the new format
						local faction_list = context:world():faction_list()
						for _, faction in model_pairs(faction_list) do
							local faction_key = faction:name()
							local saved_key = faction_key .. "_won_battles_tech"
							local wins_count = cm:get_saved_value(saved_key) or 0
							if wins_count > 0 then
								scripted_technology_tree.persistent.battle_wins[faction_key] = {
									[scripted_technology_tree.target_culture_any] = wins_count
								}

								cm:clear_saved_value(saved_key)
							end
						end
					end,
					false
				)
			end

			-- now set it to the current version so it will be stored properly
			scripted_technology_tree.persistent.version = current_version
		end
	end
)

dechala_settlement_exploitation_config = {
	faction_key = "wh3_dlc27_sla_the_tormentors",
	region_ritual_key = "wh3_dlc27_sla_ritual_dechala_permanent_settlement",
	script_state = "settlement_exploitation_permanent",
	short_victory_key = "wh3_dlc27_mission_dechala_exploitation_short_victory",
	long_victory_key = "wh3_dlc27_mission_dechala_exploitation_long_victory",
	traded_settlement_thralls_replenishment_turn_cap = 30, -- ensure that transfered regions regenerate thralls slower than the rate they decrease at to prevent going over 1k thralls per settlement
	traded_settlement_default_thrall_value = 1000,
	traded_settlement_factor = "wh3_dlc27_sla_thralls_region_occupation",
	thralls_region_resource = {
		key = "wh3_dlc27_sla_thralls_region",
		occupation_factor = "wh3_dlc27_sla_thralls_region_occupation",
		start_pos_value = 1000,
		technology_factor = "wh3_dlc27_sla_thralls_region_technologies",
		technology_value = "wh3_dlc27_sla_dechala_technology_thralls_per_occupation",
		occupation_decisions = {
			occupy = "occupation_decision_occupy",
			loot_and_occupy = "occupation_decision_loot",
		},
	},
	pleasure_palace_availability = {
		range_unavailable = {
			min = 0,
			max = 2,
		},
		building_chain = "wh3_dlc27_sla_dec_palace_settlement",
		resource_factor = "wh3_dlc27_sla_pleaure_palace_available",
		settlement_type = "wh3_dlc27_dechala_pleasure_palace",
		resource_increment = 1,
		resource_decrement = -1,
	},
}

settlement_exploitation = {}
settlement_exploitation.exploited_regions_data = {}
settlement_exploitation.traded_regions_data = {}

function settlement_exploitation:initialise()
	self:refresh_pleasure_palace_availability()
	self:add_pleasure_palace_listeners()
	self:add_traded_regions_listeners()

	core:add_listener(
		"settlement_exploitation_ritual_completed",
		"RitualCompletedEvent",
		function(context)
			return context:ritual():ritual_key() == dechala_settlement_exploitation_config.region_ritual_key and context:performing_faction():name() == dechala_settlement_exploitation_config.faction_key
		end,
		function(context)
			local ritual = context:ritual()
			local ritual_target = ritual:ritual_target()
			local target_type = ritual_target:target_type()
			if target_type == "REGION" then
				local target_region = ritual_target:get_target_region()
				if target_region:is_null_interface() == false then
					cm:set_script_state(target_region, dechala_settlement_exploitation_config.script_state, true)
				end
			end
		end,
		true
	)

	core:add_listener(
		"dechala_lock_devotees_rituals",
		"FactionTurnStart",
		function(context)
			return context:faction():name() == dechala_settlement_exploitation_config.faction_key
		end,
		function(context)
			local faction = context:faction()
			if faction:name() == dechala_settlement_exploitation_config.faction_key and cm:is_new_game() then
				cm:lock_ritual(faction, "wh3_main_ritual_sla_pleasure_hunt")
				cm:lock_ritual(faction, "wh3_main_ritual_sla_pleasure_arena")
				cm:lock_ritual(faction, "wh3_main_ritual_sla_pleasure_party")
			end
		end,
		false
	);

	core:add_listener(
		"dechala_bonus_thralls_on_occupation",
		"CharacterPerformsSettlementOccupationDecision",
		function(context)
			local cfg = dechala_settlement_exploitation_config
			
			-- validate faction
			local faction_name = context:character():faction():name()
			if faction_name ~= cfg.faction_key then
				return false
			end

			-- validate occupation decision
			local decision = context:occupation_decision_type();
			for _, v in pairs(cfg.thralls_region_resource.occupation_decisions) do
				if v == decision then
					return true
				end
			end
			return false 
		end,
		function(context)
			local cfg = dechala_settlement_exploitation_config
			local character = context:character()

			-- apply technology bonus
			local thralls_count = cm:get_factions_bonus_value(
				character:faction(),
				cfg.thralls_region_resource.technology_value
			)
			if thralls_count > 0 then
				cm:entity_add_pooled_resource_transaction(
					character:region(),
					cfg.thralls_region_resource.technology_factor,
					thralls_count
				)
			end
		end,
		true
	);
end

function settlement_exploitation:has_pleasure_palace(settlement, level_range)
	local primary_slot = settlement:primary_slot()
	if primary_slot == nil or primary_slot:is_null_interface() or not primary_slot:has_building() then
		return false
	end

	local building = primary_slot:building()
	if building:chain() ~= dechala_settlement_exploitation_config.pleasure_palace_availability.building_chain then
		return false
	end

	local level = building:building_level()
	return level >= level_range.min and level <= level_range.max
end

function settlement_exploitation:faction_owns_low_level_pleasure_palace(faction)
	local region_list = faction:region_list()
	for i = 0, region_list:num_items() - 1 do
		local region = region_list:item_at(i)
		if region:is_province_capital() then
			if self:has_pleasure_palace(region:settlement(), dechala_settlement_exploitation_config.pleasure_palace_availability.range_unavailable) then
				return true
			end
		end
	end

	return false
end

function settlement_exploitation:set_pleasure_palace_availability(faction, allow)
	local value = (allow and dechala_settlement_exploitation_config.pleasure_palace_availability.resource_increment)
					or dechala_settlement_exploitation_config.pleasure_palace_availability.resource_decrement

	cm:entity_add_pooled_resource_transaction(
		faction,
		dechala_settlement_exploitation_config.pleasure_palace_availability.resource_factor,
		value
	)
end

function settlement_exploitation:refresh_pleasure_palace_availability(faction, allow)
	if faction == nil then
		faction = cm:get_faction(dechala_settlement_exploitation_config.faction_key)
		-- if we can't find Dechala's faction this is a save from before 7.0, just return
		if faction == false then
			return
		end
	end

	if allow == nil then
		allow = not self:faction_owns_low_level_pleasure_palace(faction)
	end
 
	self:set_pleasure_palace_availability(faction, allow)
end

function settlement_exploitation:add_traded_regions_listeners()

	core:add_listener(
		"dechala_loses_region_trading",
		"RegionFactionChangeEvent",
		function(context)
			return context:reason() == "diplomacy trade" and context:previous_faction():name() == dechala_settlement_exploitation_config.faction_key
		end,
		function(context)
			local region_key = context:region():name()
			if not self.traded_regions_data[region_key] then  
				self.traded_regions_data[region_key] = {}
				self.traded_regions_data[region_key].turn_traded = cm:turn_number()
			end

		end,
		true
	);

	core:add_listener(
		"dechala_receives_region_trading",
		"RegionFactionChangeEvent",
		function(context)

			return context:reason() == "diplomacy trade" and context:region():owning_faction():name() == dechala_settlement_exploitation_config.faction_key
		end,
		function(context)
			local region = context:region()
			local region_key = region:name()
			local faction = context:region():owning_faction()
			local cfg = dechala_settlement_exploitation_config

			local thralls_count = cfg.traded_settlement_default_thrall_value
			if self.traded_regions_data[region_key] then 
				local current_turn = cm:turn_number() 
				local round_difference = current_turn - self.traded_regions_data[region_key].turn_traded

				round_difference = math.min(round_difference, cfg.traded_settlement_thralls_replenishment_turn_cap)

				-- Formula - calculate how many thralls are replenished per turn * the amount of turns the settlement has not been with dechala
				-- It is possible for recalculated_thralls to be the same value as thralls_count
				thralls_count = math.floor((thralls_count / cfg.traded_settlement_thralls_replenishment_turn_cap) * round_difference)
				self.traded_regions_data[region_key] = nil
			end

			if thralls_count > 0 then
				cm:entity_add_pooled_resource_transaction(
					region,
					cfg.traded_settlement_factor,
					thralls_count
				)
			end

		end,
		true
	);

end

function settlement_exploitation:add_pleasure_palace_listeners()
	-- Dechala lost a settlement, refresh pleasure palace availability
	-- Not suitable for use when Dechala has *gained* a settlement, because buildings haven't been converted yet
	core:add_listener(
		"dechala_region_lost_refresh_pleasure_palace_availability",
		"RegionFactionChangeEvent",
		function(context)
			local dechala_key = dechala_settlement_exploitation_config.faction_key

			local prev_faction = context:previous_faction()
			if prev_faction ~= nil and not prev_faction:is_null_interface() and prev_faction:name() == dechala_key then
				return true 
			end
			
			return false
		end,
		function(context)
			self:refresh_pleasure_palace_availability()
		end,
		true
	);

	-- Settlement is marked for conversion to pleasure palace, remove availability
	core:add_listener(
		"dechala_pleasure_palace_mark_for_conversion",
		"SettlementMarkedForTypeConversionEvent",
		function(context)
			if context:settlement():faction():name() ~= dechala_settlement_exploitation_config.faction_key then
				return false
			end

			if context:conversion_settlement_type() ~= dechala_settlement_exploitation_config.pleasure_palace_availability.settlement_type then
				return false
			end

			return true
		end,
		function(context)
			self:refresh_pleasure_palace_availability(context:settlement():faction(), false)
		end,
		true
	);

	-- Settlement is unmarked for conversion to pleasure palace, restore availability
	core:add_listener(
		"dechala_pleasure_palace_unmark_for_conversion",
		"SettlementUnMarkedForTypeConversionEvent",
		function(context)
			if context:settlement():faction():name() ~= dechala_settlement_exploitation_config.faction_key then
				return false
			end

			if context:conversion_settlement_type() ~= dechala_settlement_exploitation_config.pleasure_palace_availability.settlement_type then
				return false
			end

			return true
		end,
		function(context)
			self:refresh_pleasure_palace_availability(context:settlement():faction(), true)
		end,
		true
	);

	-- Dechala has gained or converted a settlement, refresh pleasure palace availability
	core:add_listener(
		"dechala_settlement_converted_to_pleasure_palace",
		"SettlementTypeConvertedEvent",
		function(context)
			if context:settlement():faction():name() ~= dechala_settlement_exploitation_config.faction_key then
				return false
			end

			return true
		end,
		function(context)
			self:refresh_pleasure_palace_availability(context:settlement():faction())
		end,
		true
	);
end

--------------------------------------------------------------
----------------------- START POS SETUP ----------------------
--------------------------------------------------------------

cm:add_first_tick_callback_new(
	function()
		local faction = cm:get_faction(dechala_settlement_exploitation_config.faction_key)
		local home_region = faction:home_region();
		cm:entity_add_pooled_resource_transaction(home_region, dechala_settlement_exploitation_config.thralls_region_resource.occupation_factor, dechala_settlement_exploitation_config.thralls_region_resource.start_pos_value)
		cm:set_script_state(home_region, dechala_settlement_exploitation_config.script_state, true)
	end
)

--------------------------------------------------------------
----------------------- SAVING / LOADING ---------------------
--------------------------------------------------------------

cm:add_saving_game_callback(
	function(context)
		cm:save_named_value("exploited_regions", settlement_exploitation.exploited_regions_data, context)
		cm:save_named_value("traded_regions", settlement_exploitation.traded_regions_data, context)
	end
)

cm:add_loading_game_callback(
	function(context)
		settlement_exploitation.exploited_regions_data = cm:load_named_value("exploited_regions", settlement_exploitation.exploited_regions_data, context)
		settlement_exploitation.traded_regions_data = cm:load_named_value("traded_regions", settlement_exploitation.traded_regions_data, context)
	end
)
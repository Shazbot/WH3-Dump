
eye_of_the_gods = {
	ritual_category_key = "EYE_OF_THE_GODS",
	ritual_key = "wh3_dlc20_ritual_chs_eye_of_the_gods",
	resource_cost = "wh3_dlc20_ritual_eye_of_the_gods_required",

	factions_to_dilemmas = {
		default = "wh3_dlc20_chs_eye_of_the_gods",
		wh3_dlc20_chs_valkia = "wh3_dlc20_chs_eye_of_the_gods_kho",
		wh3_dlc20_chs_festus = "wh3_dlc20_chs_eye_of_the_gods_nur",
		wh3_dlc20_chs_azazel = "wh3_dlc20_chs_eye_of_the_gods_sla",
		wh3_dlc20_chs_vilitch = "wh3_dlc20_chs_eye_of_the_gods_tze"

	},

	payloads = {
		wh3_dlc20_chs_eye_of_the_gods= {
			FIRST = {
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_death",
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_fire",
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_kho",
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_metal",
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_shadows",
				"wh3_dlc20_payload_eye_of_the_gods_healing_nur",
				"wh3_dlc20_payload_eye_of_the_gods_marauders",
				"wh3_dlc20_payload_eye_of_the_gods_movement_kho",
				"wh3_dlc20_payload_eye_of_the_gods_sneak_tze",
				"wh3_dlc20_payload_eye_of_the_gods_spawn_frenzy",
				"wh3_dlc20_payload_eye_of_the_gods_unit_xp",

			},
			SECOND = { 
				"wh3_dlc20_payload_eye_of_the_gods_char_xp_all",
				"wh3_dlc20_payload_eye_of_the_gods_character_attack_defence",
				"wh3_dlc20_payload_eye_of_the_gods_character_capacity_exalted_hero",
				"wh3_dlc20_payload_eye_of_the_gods_character_capacity_sorcerer",
				"wh3_dlc20_payload_eye_of_the_gods_character_recruit",
				"wh3_dlc20_payload_eye_of_the_gods_character_upgrade",
				"wh3_dlc20_payload_eye_of_the_gods_random_items_scripted",
				"wh3_dlc20_payload_eye_of_the_gods_xp_target",
				"wh3_dlc20_payload_eye_of_the_gods_immortality",
				"wh3_dlc20_payload_eye_of_the_gods_magic"
			},
			THIRD = { 
				"wh3_dlc20_payload_eye_of_the_gods_units_kho_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_nur_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_sla_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_tze_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_2",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_3",
				"wh3_dlc20_payload_eye_of_the_gods_movement_sla",
				"wh3_dlc20_payload_eye_of_the_gods_nur_growth",
				"wh3_dlc20_payload_eye_of_the_gods_kho_recruit",
				"wh3_dlc20_payload_eye_of_the_gods_tze_tech",
				"wh3_dlc20_payload_eye_of_the_gods_war_coord",
				"wh3_dlc20_payload_eye_of_the_gods_sla_control",
				"wh3_dlc20_payload_eye_of_the_gods_favour",

			},

			FOURTH = {
				"wh3_dlc20_payload_eye_of_the_gods_gifts_cost",
			}
		},

		wh3_dlc20_chs_eye_of_the_gods_sla = {
			FIRST = {
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_shadows",
				"wh3_dlc20_payload_eye_of_the_gods_marauders",
				"wh3_dlc20_payload_eye_of_the_gods_spawn_frenzy",
				"wh3_dlc20_payload_eye_of_the_gods_unit_xp",
				"wh3_dlc20_payload_eye_of_the_gods_movement_sla",
				"wh3_dlc20_payload_eye_of_the_gods_features_sla",

			},
			SECOND = { 
				"wh3_dlc20_payload_eye_of_the_gods_char_xp_all",
				"wh3_dlc20_payload_eye_of_the_gods_character_attack_defence",
				"wh3_dlc20_payload_eye_of_the_gods_random_item_sla_scripted",
				"wh3_dlc20_payload_eye_of_the_gods_character_capacity_exalted_hero",
				"wh3_dlc20_payload_eye_of_the_gods_character_capacity_sorcerer",
				"wh3_dlc20_payload_eye_of_the_gods_character_recruit",
				"wh3_dlc20_payload_eye_of_the_gods_character_upgrade",
				"wh3_dlc20_payload_eye_of_the_gods_random_items_scripted",
				"wh3_dlc20_payload_eye_of_the_gods_xp_target",
				"wh3_dlc20_payload_eye_of_the_gods_immortality",
				"wh3_dlc20_payload_eye_of_the_gods_magic"
			},
			THIRD = { 
				"wh3_dlc20_payload_eye_of_the_gods_units_sla_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_sla_2",
				"wh3_dlc20_payload_eye_of_the_gods_units_sla_3",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_2",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_3",
				"wh3_dlc20_payload_eye_of_the_gods_war_coord",
				"wh3_dlc20_payload_eye_of_the_gods_sla_control",
				"wh3_dlc20_payload_eye_of_the_gods_favour",
			},

			FOURTH = {
				"wh3_dlc20_payload_eye_of_the_gods_gifts_cost",
			}
		},
		wh3_dlc20_chs_eye_of_the_gods_kho= {
			FIRST = {
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_kho",
				"wh3_dlc20_payload_eye_of_the_gods_marauders",
				"wh3_dlc20_payload_eye_of_the_gods_movement_kho",
				"wh3_dlc20_payload_eye_of_the_gods_spawn_frenzy",
				"wh3_dlc20_payload_eye_of_the_gods_unit_xp",

			},
			SECOND = { 
				"wh3_dlc20_payload_eye_of_the_gods_char_xp_all",
				"wh3_dlc20_payload_eye_of_the_gods_character_attack_defence",
				"wh3_dlc20_payload_eye_of_the_gods_random_item_kho_scripted",
				"wh3_dlc20_payload_eye_of_the_gods_character_capacity_exalted_hero",
				"wh3_dlc20_payload_eye_of_the_gods_character_recruit",
				"wh3_dlc20_payload_eye_of_the_gods_character_upgrade",
				"wh3_dlc20_payload_eye_of_the_gods_random_items_scripted",
				"wh3_dlc20_payload_eye_of_the_gods_xp_target",
				"wh3_dlc20_payload_eye_of_the_gods_immortality",
			},
			THIRD = { 
				"wh3_dlc20_payload_eye_of_the_gods_units_kho_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_kho_2",
				"wh3_dlc20_payload_eye_of_the_gods_units_kho_3",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_2",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_3",
				"wh3_dlc20_payload_eye_of_the_gods_kho_recruit",
				"wh3_dlc20_payload_eye_of_the_gods_war_coord",
				"wh3_dlc20_payload_eye_of_the_gods_favour",

			},

			FOURTH = {
				"wh3_dlc20_payload_eye_of_the_gods_gifts_cost",
			}
		},
		wh3_dlc20_chs_eye_of_the_gods_nur= {
			FIRST = {
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_death",
				"wh3_dlc20_payload_eye_of_the_gods_features_nur",
				"wh3_dlc20_payload_eye_of_the_gods_healing_nur",
				"wh3_dlc20_payload_eye_of_the_gods_marauders",
				"wh3_dlc20_payload_eye_of_the_gods_spawn_frenzy",
				"wh3_dlc20_payload_eye_of_the_gods_unit_xp",

			},
			SECOND = { 
				"wh3_dlc20_payload_eye_of_the_gods_char_xp_all",
				"wh3_dlc20_payload_eye_of_the_gods_character_attack_defence",
				"wh3_dlc20_payload_eye_of_the_gods_character_capacity_exalted_hero",
				"wh3_dlc20_payload_eye_of_the_gods_character_capacity_sorcerer",
				"wh3_dlc20_payload_eye_of_the_gods_character_recruit",
				"wh3_dlc20_payload_eye_of_the_gods_character_upgrade",
				"wh3_dlc20_payload_eye_of_the_gods_random_items_scripted",
				"wh3_dlc20_payload_eye_of_the_gods_xp_target",
				"wh3_dlc20_payload_eye_of_the_gods_immortality",
				"wh3_dlc20_payload_eye_of_the_gods_magic"
			},
			THIRD = {
				"wh3_dlc20_payload_eye_of_the_gods_units_nur_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_nur_2",
				"wh3_dlc20_payload_eye_of_the_gods_units_nur_3",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_2",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_3",
				"wh3_dlc20_payload_eye_of_the_gods_nur_growth",
				"wh3_dlc20_payload_eye_of_the_gods_war_coord",
				"wh3_dlc20_payload_eye_of_the_gods_favour",
			},

			FOURTH = {
				"wh3_dlc20_payload_eye_of_the_gods_gifts_cost",
			}
		},
		wh3_dlc20_chs_eye_of_the_gods_tze= {
			FIRST = {
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_death",
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_fire",
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_metal",
				"wh3_dlc20_payload_eye_of_the_gods_cataclysm_shadows",
				"wh3_dlc20_payload_eye_of_the_gods_marauders",
				"wh3_dlc20_payload_eye_of_the_gods_sneak_tze",
				"wh3_dlc20_payload_eye_of_the_gods_spawn_frenzy",
				"wh3_dlc20_payload_eye_of_the_gods_unit_xp",

			},
			SECOND = { 
				"wh3_dlc20_payload_eye_of_the_gods_char_xp_all",
				"wh3_dlc20_payload_eye_of_the_gods_character_attack_defence",
				"wh3_dlc20_payload_eye_of_the_gods_character_capacity_exalted_hero",
				"wh3_dlc20_payload_eye_of_the_gods_character_capacity_sorcerer",
				"wh3_dlc20_payload_eye_of_the_gods_character_recruit",
				"wh3_dlc20_payload_eye_of_the_gods_character_upgrade",
				"wh3_dlc20_payload_eye_of_the_gods_random_items_scripted",
				"wh3_dlc20_payload_eye_of_the_gods_xp_target",
				"wh3_dlc20_payload_eye_of_the_gods_immortality",
				"wh3_dlc20_payload_eye_of_the_gods_magic"
			},
			THIRD = {
				"wh3_dlc20_payload_eye_of_the_gods_units_tze_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_tze_2",
				"wh3_dlc20_payload_eye_of_the_gods_units_tze_3",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_1",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_2",
				"wh3_dlc20_payload_eye_of_the_gods_units_und_3",
				"wh3_dlc20_payload_eye_of_the_gods_tze_tech",
				"wh3_dlc20_payload_eye_of_the_gods_war_coord",
				"wh3_dlc20_payload_eye_of_the_gods_features_tze",
				"wh3_dlc20_payload_eye_of_the_gods_favour",
			},

			FOURTH = {
				"wh3_dlc20_payload_eye_of_the_gods_gifts_cost",
			}
		},
	},

	payload_scripted_components = {
		wh3_dlc20_payload_eye_of_the_gods_xp_target = 
			function(custom_payload, faction_interface)
				local random_char = eye_of_the_gods:get_random_character(faction_interface, true)

				if random_char then
					custom_payload:character_experience_change(random_char, 4000)
				else
					custom_payload:components_from_record("wh3_dlc20_payload_eye_of_the_gods_char_xp_all", faction_interface, faction_interface)
				end

			end,

		wh3_dlc20_payload_eye_of_the_gods_character_capacity_sorcerer = 
			function(custom_payload, faction_interface)
				custom_payload:agent_capacity_adjustment(faction_interface, "wizard",1)
				custom_payload:text_display("dummy_sorcerer_capacity")
			end,

		wh3_dlc20_payload_eye_of_the_gods_character_capacity_exalted_hero = 
			function(custom_payload, faction_interface)
				custom_payload:agent_capacity_adjustment(faction_interface, "champion",1)
				custom_payload:text_display("dummy_exalted_hero_capacity")
			end,

		wh3_dlc20_payload_eye_of_the_gods_random_items_scripted = 
			function(custom_payload, faction_interface)
				custom_payload:faction_ancillary_gain(faction_interface, get_random_ancillary_key_for_faction(faction_interface:name(), false, "rare"))
				custom_payload:faction_ancillary_gain(faction_interface, get_random_ancillary_key_for_faction(faction_interface:name(), false, "rare"))
				custom_payload:faction_ancillary_gain(faction_interface, get_random_ancillary_key_for_faction(faction_interface:name(), false, "uncommon"))
			end,

		wh3_dlc20_payload_eye_of_the_gods_random_item_kho_scripted = 
			function(custom_payload, faction_interface)

				local random_char = eye_of_the_gods:get_random_character(faction_interface, true)
				local khorne_items = {
					"wh3_main_anc_weapon_the_bane_spear",
					"wh3_main_anc_weapon_chainsword",
					"wh3_main_anc_weapon_gilellions_soulnetter",
					"wh3_main_anc_weapon_skars_kraken_killer"
				}

				if cm:get_saved_value("eotg_khorne_item_granted") or not random_char then
					custom_payload:faction_ancillary_gain(faction_interface, get_random_ancillary_key_for_faction(faction_interface:name(), "weapon", "rare"))
					custom_payload:faction_ancillary_gain(faction_interface, get_random_ancillary_key_for_faction(faction_interface:name(), "weapon", "rare"))
				else
					custom_payload:faction_ancillary_gain(faction_interface, khorne_items[cm:random_number(#khorne_items)])
					custom_payload:character_to_wound(random_char)
					cm:set_saved_value("eotg_khorne_item_granted", true)
				end

			end,

		wh3_dlc20_payload_eye_of_the_gods_random_item_sla_scripted = 
			function(custom_payload, faction_interface)

				local random_char = eye_of_the_gods:get_random_character(faction_interface, true)

				if cm:get_saved_value("eotg_slaanesh_item_granted") or not random_char then
					custom_payload:faction_ancillary_gain(faction_interface, get_random_ancillary_key_for_faction(faction_interface:name(), "weapon", "rare"))
					custom_payload:faction_ancillary_gain(faction_interface, get_random_ancillary_key_for_faction(faction_interface:name(), "weapon", "rare"))
				else
					custom_payload:faction_ancillary_gain(faction_interface, "wh3_main_anc_weapon_slaaneshs_blade")
					custom_payload:character_to_wound(random_char) 
					cm:set_saved_value("eotg_slaanesh_item_granted", true)
				end

			end,
	}
}


function eye_of_the_gods:initialise()
	local human_factions = cm:get_human_factions()

	for i = 1, #human_factions do 
		local faction_interface = cm:get_faction(human_factions[i])
		if faction_interface:is_human() and faction_interface:has_access_to_ritual_category(self.ritual_category_key) then
			cm:add_faction_turn_start_listener_by_name(
				"EotGAvailable", 
				human_factions[i], 
				function(context)
					if context:faction():pooled_resource_manager():can_afford_resource_cost(self.resource_cost) then
						cm:perform_ritual(context:faction():name(), "", self.ritual_key)
					end
				end, 
				true)
		end
		
	end

	core:add_listener(
		"EotGRitualCompletedEvent",
		"RitualCompletedEvent",
		function(context)
			return context:performing_faction() ~= nil and context:ritual():ritual_category() == self.ritual_category_key
		end,
		function(context)
			self:generate_dilemma(context:performing_faction():name())
		end,
		true
	)
end

function eye_of_the_gods:generate_dilemma(faction_key)
	local dilemma_key = self.factions_to_dilemmas[faction_key] or self.factions_to_dilemmas.default
	local dilemma_builder = cm:create_dilemma_builder(dilemma_key)
	local choices = dilemma_builder:possible_choices()
	local faction_interface = cm:get_faction(faction_key)

	for i = 1, #choices do
		local payload = self:generate_payload(choices[i], faction_interface, dilemma_key)
		dilemma_builder:add_choice_payload(choices[i], payload)
	end

	cm:launch_custom_dilemma_from_builder(dilemma_builder, cm:get_faction(faction_key))
end

function eye_of_the_gods:generate_payload(choice, faction_interface, dilemma)

	local payload_options = self.payloads[dilemma][choice]

	local random_payload = payload_options[cm:random_number(#payload_options)]
	local custom_payload = cm:create_payload()

	if self.payload_scripted_components[random_payload] then
		local scripted_components = self.payload_scripted_components[random_payload]
		scripted_components(custom_payload, faction_interface)
	else
		custom_payload:components_from_record(random_payload, faction_interface, faction_interface)
	end

	custom_payload:components_from_record("wh3_dlc20_payload_eye_of_the_gods_progress_cost", faction_interface, faction_interface)

	return custom_payload
end


function eye_of_the_gods:get_random_character(faction_interface, exclude_faction_leader)
	local character_list = faction_interface:character_list()
	local valid_target_chars = {}
	local random_char = false

	for i, character in model_pairs(character_list) do
		if not character:character_type("colonel") and character:rank() < 45 and not (character:is_faction_leader() and exclude_faction_leader) then
			table.insert(valid_target_chars, character)
		end
	end

	if #valid_target_chars > 0 then
		random_char = valid_target_chars[cm:random_number(#valid_target_chars)]
	end

	return random_char

end